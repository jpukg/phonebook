<?xml version="1.0" encoding="UTF-8"?>
<beans:beans xmlns="http://www.springframework.org/schema/integration"
             xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
             xmlns:beans="http://www.springframework.org/schema/beans"
             xmlns:mail="http://www.springframework.org/schema/integration/mail"
             xsi:schemaLocation="http://www.springframework.org/schema/beans
                                 http://www.springframework.org/schema/beans/spring-beans.xsd
                                 http://www.springframework.org/schema/integration
                                 http://www.springframework.org/schema/integration/spring-integration.xsd
                                 http://www.springframework.org/schema/integration/mail
                                 http://www.springframework.org/schema/integration/mail/spring-integration-mail.xsd">


    <gateway id="resetPasswordService"
             service-interface="it.valeriovaudi.service.PasswordService"
             default-request-channel="resetPasswordServiceMainRequestChannel"/>

    <channel id="resetPasswordServiceMainRequestChannel"/>

    <chain id="createNonceChain"
            input-channel="resetPasswordServiceMainRequestChannel"
            output-channel="sendMai4ResetPasswordMainRequestChannel">
        <service-activator expression="@phonBookUserRepository.findByUserName(payload)"/>
        <service-activator expression="@nonceFactoryByUser.getNonce(payload)"/>
        <service-activator expression="@nonceRepository.save(payload)"/>
        <service-activator expression="payload.nonce"/>
        <mail:header-enricher>
            <mail:to expression="headers['mail']"/>
            <mail:subject value="mail reset service"/>
        </mail:header-enricher>
    </chain>

    <channel id="sendMai4ResetPasswordMainRequestChannel"/>


    <mail:outbound-channel-adapter channel="sendMai4ResetPasswordMainRequestChannel"
                                   mail-sender="mailSender"/>
</beans:beans>
